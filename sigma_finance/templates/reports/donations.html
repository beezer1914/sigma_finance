{% extends "base.html" %}

{% block title %}Donations Report{% endblock %}

{% block content %}
<div class="container my-5">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-4">üíù Donations Report</h1>
            <p class="text-muted">Comprehensive donation statistics and donor recognition</p>
            <hr>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Total Donations</h5>
                    <h2 class="text-primary">${{ "%.2f"|format(summary.total_amount) }}</h2>
                    <p class="text-muted mb-0">{{ summary.total_donations }} donations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Unique Donors</h5>
                    <h2 class="text-success">{{ summary.unique_donors }}</h2>
                    <p class="text-muted mb-0">different donors</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Average Donation</h5>
                    <h2 class="text-info">${{ "%.2f"|format(summary.avg_donation) }}</h2>
                    <p class="text-muted mb-0">per donation</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Member Donations</h5>
                    <h2 class="text-warning">{{ summary.member_donations }}</h2>
                    <p class="text-muted mb-0">${{ "%.2f"|format(summary.member_amount) }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Buttons -->
    <div class="row mb-4">
        <div class="col-md-12">
            <a href="{{ url_for('reports.export_donations') }}" class="btn btn-success me-2">
                üì• Export All Donations
            </a>
            <a href="{{ url_for('reports.export_top_donors') }}" class="btn btn-primary">
                üì• Export Top Donors
            </a>
        </div>
    </div>

    <!-- Top Donors Section -->
    {% if top_donors %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h3 class="mb-0">üèÜ Top 10 Donors</h3>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Donor</th>
                                <th>Email</th>
                                <th class="text-end">Total Donated</th>
                                <th class="text-center">Donations</th>
                                <th>Level</th>
                                <th>Member</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for donor in top_donors %}
                            <tr>
                                <td><strong>{{ loop.index }}</strong></td>
                                <td>
                                    {{ donor.donor_name }}
                                    {% if donor.has_anonymous_donations %}<span class="badge bg-secondary ms-1">*</span>{% endif %}
                                </td>
                                <td class="text-muted">{{ donor.donor_email }}</td>
                                <td class="text-end text-success fw-bold">${{ "%.2f"|format(donor.total_donated|float) }}</td>
                                <td class="text-center">{{ donor.donation_count }}</td>
                                <td>
                                    <span class="badge
                                        {% if donor.donor_level == 'Champion' %}bg-danger
                                        {% elif donor.donor_level == 'Benefactor' %}bg-warning
                                        {% elif donor.donor_level == 'Patron' %}bg-info
                                        {% elif donor.donor_level == 'Supporter' %}bg-primary
                                        {% else %}bg-secondary{% endif %}">
                                        {{ donor.donor_level }}
                                    </span>
                                </td>
                                <td>
                                    {% if donor.member_name %}
                                        <span class="badge bg-success">{{ donor.member_name }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <p class="text-muted mb-0"><small>* Has made some anonymous donations</small></p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Monthly Summary -->
    {% if monthly %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">üìÖ Monthly Summary</h3>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Donations</th>
                                <th class="text-end">Unique Donors</th>
                                <th class="text-end">Total Amount</th>
                                <th class="text-end">Avg</th>
                                <th class="text-end">Members</th>
                                <th class="text-end">Non-Members</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month in monthly[:12] %}
                            <tr>
                                <td><strong>{{ month.month_name }}</strong></td>
                                <td class="text-end">{{ month.donation_count }}</td>
                                <td class="text-end">{{ month.unique_donors }}</td>
                                <td class="text-end text-success fw-bold">${{ "%.2f"|format(month.total_amount|float) }}</td>
                                <td class="text-end">${{ "%.2f"|format(month.avg_amount|float) }}</td>
                                <td class="text-end">
                                    {{ month.member_donations }} <span class="text-muted">(${{ "%.2f"|format(month.member_amount|float) }})</span>
                                </td>
                                <td class="text-end">
                                    {{ month.non_member_donations }} <span class="text-muted">(${{ "%.2f"|format(month.non_member_amount|float) }})</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Donations Table -->
    {% if donations %}
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">üìã All Donations</h3>
                </div>
                <div class="card-body">
                    <table class="table table-sm table-hover">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Donor</th>
                                <th class="text-end">Amount</th>
                                <th>Tier</th>
                                <th>Type</th>
                                <th>Method</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for donation in donations[:50] %}
                            <tr>
                                <td>{{ donation.date.strftime('%Y-%m-%d') if donation.date else 'N/A' }}</td>
                                <td>
                                    {% if donation.anonymous %}
                                        <em class="text-muted">Anonymous</em>
                                    {% else %}
                                        {{ donation.donor_name }}
                                        {% if donation.member_name %}
                                            <span class="badge bg-success ms-1">Member</span>
                                        {% endif %}
                                    {% endif %}
                                </td>
                                <td class="text-end fw-bold">${{ "%.2f"|format(donation.amount|float) }}</td>
                                <td>
                                    <span class="badge
                                        {% if 'Premium' in donation.donation_tier %}bg-danger
                                        {% elif 'Major' in donation.donation_tier %}bg-warning
                                        {% elif 'Large' in donation.donation_tier %}bg-info
                                        {% elif 'Medium' in donation.donation_tier %}bg-primary
                                        {% else %}bg-secondary{% endif %}">
                                        {{ donation.donation_tier }}
                                    </span>
                                </td>
                                <td>
                                    <span class="badge {% if donation.donor_type == 'Member' %}bg-success{% else %}bg-secondary{% endif %}">
                                        {{ donation.donor_type }}
                                    </span>
                                </td>
                                <td class="text-muted">{{ donation.method|title }}</td>
                                <td class="text-muted"><small>{{ donation.notes or '‚Äî' }}</small></td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    {% if donations|length > 50 %}
                    <p class="text-muted text-center mt-3">
                        <small>Showing first 50 of {{ donations|length }} donations. Export to CSV for full list.</small>
                    </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="row">
        <div class="col-md-12">
            <div class="alert alert-info">
                <h4 class="alert-heading">No Donations Yet</h4>
                <p>No donation records found. Once donations are received, they will appear here.</p>
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}
