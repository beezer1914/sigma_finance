{% extends "base.html" %}

{% block title %}Donations Report{% endblock %}

{% block extra_head %}
<!-- HTMX for dynamic content updates -->
<script src="https://unpkg.com/htmx.org@1.9.10"></script>
<!-- Alpine.js for simple client-side interactivity -->
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>

<style>
    /* Show loading indicator only when HTMX is fetching */
    .htmx-indicator {
        opacity: 0;
        transition: opacity 300ms ease-in;
    }
    .htmx-request .htmx-indicator {
        opacity: 1;
    }

    /* Smooth transitions for Alpine.js */
    [x-cloak] { display: none !important; }

    /* Smooth fade during HTMX swaps */
    .htmx-swapping {
        opacity: 0;
        transition: opacity 200ms ease-out;
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-5" x-data="{ showFilters: false }">
    <div class="row mb-4">
        <div class="col-md-12">
            <h1 class="display-4">üíù Donations Report</h1>
            <p class="text-muted">Comprehensive donation statistics and donor recognition</p>
            <hr>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="row g-4 mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Total Donations</h5>
                    <h2 class="text-primary">${{ "%.2f"|format(summary.total_amount) }}</h2>
                    <p class="text-muted mb-0">{{ summary.total_donations }} donations</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Unique Donors</h5>
                    <h2 class="text-success">{{ summary.unique_donors }}</h2>
                    <p class="text-muted mb-0">different donors</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Average Donation</h5>
                    <h2 class="text-info">${{ "%.2f"|format(summary.avg_donation) }}</h2>
                    <p class="text-muted mb-0">per donation</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-muted">Member Donations</h5>
                    <h2 class="text-warning">{{ summary.member_donations }}</h2>
                    <p class="text-muted mb-0">${{ "%.2f"|format(summary.member_amount) }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Filter Bar - HTMX Enhanced -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">üîç Filters</h5>
                    <button class="btn btn-sm btn-outline-secondary"
                            @click="showFilters = !showFilters"
                            x-text="showFilters ? 'Hide Filters' : 'Show Filters'">
                        Show Filters
                    </button>
                </div>

                <div class="card-body" x-show="showFilters" x-transition x-cloak>
                    <form id="donation-filters"
                          hx-get="{{ url_for('reports.donations_filtered') }}"
                          hx-target="#donations-table-container"
                          hx-trigger="change, keyup delay:500ms from:#search-input"
                          hx-indicator="#loading-indicator"
                          hx-swap="innerHTML swap:300ms">

                        <div class="row g-3">
                            <!-- Date Range -->
                            <div class="col-md-3">
                                <label class="form-label">From Date</label>
                                <input type="date" name="date_from" class="form-control"
                                       placeholder="Start date">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label">To Date</label>
                                <input type="date" name="date_to" class="form-control"
                                       placeholder="End date">
                            </div>

                            <!-- Donor Type -->
                            <div class="col-md-3">
                                <label class="form-label">Donor Type</label>
                                <select name="donor_type" class="form-select">
                                    <option value="all">All Donors</option>
                                    <option value="member">Members Only</option>
                                    <option value="non-member">Non-Members Only</option>
                                </select>
                            </div>

                            <!-- Search -->
                            <div class="col-md-3">
                                <label class="form-label">Search Donor</label>
                                <input type="text"
                                       id="search-input"
                                       name="search"
                                       class="form-control"
                                       placeholder="Name or email..."
                                       autocomplete="off">
                            </div>
                        </div>

                        <div class="row mt-3">
                            <div class="col-md-12">
                                <button type="button"
                                        class="btn btn-outline-secondary btn-sm"
                                        onclick="document.getElementById('donation-filters').reset(); htmx.trigger('#donation-filters', 'change')">
                                    üîÑ Clear Filters
                                </button>
                                <small class="text-muted ms-3">
                                    <em>Filters update automatically as you type or select</em>
                                </small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Export Buttons with Loading Indicator -->
    <div class="row mb-4">
        <div class="col-md-12 d-flex justify-content-between align-items-center">
            <div>
                <a href="{{ url_for('reports.export_donations') }}" class="btn btn-success me-2">
                    üì• Export All Donations
                </a>
                <a href="{{ url_for('reports.export_top_donors') }}" class="btn btn-primary">
                    üì• Export Top Donors
                </a>
            </div>

            <!-- Loading indicator -->
            <div id="loading-indicator" class="htmx-indicator">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Top Donors Section -->
    {% if top_donors %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-warning">
                    <h3 class="mb-0">üèÜ Top 10 Donors</h3>
                </div>
                <div class="card-body">
                    <table class="table table-hover">
                        <thead>
                            <tr>
                                <th>Rank</th>
                                <th>Donor</th>
                                <th>Email</th>
                                <th class="text-end">Total Donated</th>
                                <th class="text-center">Donations</th>
                                <th>Level</th>
                                <th>Member</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for donor in top_donors %}
                            <tr>
                                <td><strong>{{ loop.index }}</strong></td>
                                <td>
                                    {{ donor.donor_name }}
                                    {% if donor.has_anonymous_donations %}<span class="badge bg-secondary ms-1">*</span>{% endif %}
                                </td>
                                <td class="text-muted">{{ donor.donor_email }}</td>
                                <td class="text-end text-success fw-bold">${{ "%.2f"|format(donor.total_donated|float) }}</td>
                                <td class="text-center">{{ donor.donation_count }}</td>
                                <td>
                                    <span class="badge
                                        {% if donor.donor_level == 'Champion' %}bg-danger
                                        {% elif donor.donor_level == 'Benefactor' %}bg-warning
                                        {% elif donor.donor_level == 'Patron' %}bg-info
                                        {% elif donor.donor_level == 'Supporter' %}bg-primary
                                        {% else %}bg-secondary{% endif %}">
                                        {{ donor.donor_level }}
                                    </span>
                                </td>
                                <td>
                                    {% if donor.member_name %}
                                        <span class="badge bg-success">{{ donor.member_name }}</span>
                                    {% else %}
                                        <span class="text-muted">‚Äî</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                    <p class="text-muted mb-0"><small>* Has made some anonymous donations</small></p>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Monthly Summary -->
    {% if monthly %}
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-info text-white">
                    <h3 class="mb-0">üìÖ Monthly Summary</h3>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>Month</th>
                                <th class="text-end">Donations</th>
                                <th class="text-end">Unique Donors</th>
                                <th class="text-end">Total Amount</th>
                                <th class="text-end">Avg</th>
                                <th class="text-end">Members</th>
                                <th class="text-end">Non-Members</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for month in monthly[:12] %}
                            <tr>
                                <td><strong>{{ month.month_name }}</strong></td>
                                <td class="text-end">{{ month.donation_count }}</td>
                                <td class="text-end">{{ month.unique_donors }}</td>
                                <td class="text-end text-success fw-bold">${{ "%.2f"|format(month.total_amount|float) }}</td>
                                <td class="text-end">${{ "%.2f"|format(month.avg_amount|float) }}</td>
                                <td class="text-end">
                                    {{ month.member_donations }} <span class="text-muted">(${{ "%.2f"|format(month.member_amount|float) }})</span>
                                </td>
                                <td class="text-end">
                                    {{ month.non_member_donations }} <span class="text-muted">(${{ "%.2f"|format(month.non_member_amount|float) }})</span>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- All Donations Table - HTMX Enhanced Dynamic Updates -->
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow-sm">
                <div class="card-header bg-primary text-white">
                    <h3 class="mb-0">üìã All Donations</h3>
                </div>

                <div id="donations-table-container" class="card-body">
                    {% include 'reports/partials/donations_table.html' %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
