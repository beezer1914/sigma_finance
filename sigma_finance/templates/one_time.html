{% extends "base.html" %}
{% block title %}One-Time Payment{% endblock %}
{% block content %}
<h2>Submit One-Time Payment</h2>

<form method="POST" action="{{ url_for('payments.pay') }}">
  {{ form.hidden_tag() }}

  <div class="mb-3">
    <label for="amount" class="block text-gray-800 font-medium">Payment Amount</label>
    {{ form.amount(id="amount", placeholder="Enter amount") }}
    {% for error in form.amount.errors %}
      <div class="text-danger small mt-1">{{ error }}</div>
    {% endfor %}
  </div>

  <div class="mb-3">
    <label for="method" class="block text-gray-800 font-medium">Payment Method</label>
    {{ form.method(id="method") }}
    {% for error in form.method.errors %}
      <div class="text-danger small mt-1">{{ error }}</div>
    {% endfor %}
    <div id="fee-info" class="mt-2 p-2 bg-light border rounded" style="display: none;">
      <small class="text-muted">
        <strong>Processing fee breakdown:</strong><br>
        Base amount: $<span id="base-amount">0.00</span><br>
        Processing fee (2.9% + $0.30): $<span id="processing-fee">0.00</span><br>
        <strong>Total charged: $<span id="total-amount">0.00</span></strong>
      </small>
    </div>
  </div>

  <div class="mb-3">
    <label for="type" class="block text-gray-800 font-medium">Payment Type</label>
    {{ form.type(id="type") }}
    {% for error in form.type.errors %}
      <div class="text-danger small mt-1">{{ error }}</div>
    {% endfor %}
  </div>

  <div class="mb-3">
    <label for="notes" class="block text-gray-800 font-medium">Notes</label>
    {{ form.notes(id="notes", placeholder="Optional notes about this payment") }}
    {% for error in form.notes.errors %}
      <div class="text-danger small mt-1">{{ error }}</div>
    {% endfor %}
  </div>

  <button type="submit" class="btn btn-primary">
    {{ form.submit.label.text }}
  </button>
</form>

<script>
  // Calculate total amount including Stripe processing fees
  function calculateTotalWithFees(baseAmount) {
    const feePercentage = 0.029; // 2.9%
    const fixedFee = 0.30;
    const totalWithFees = (baseAmount + fixedFee) / (1 - feePercentage);
    return totalWithFees;
  }

  function updateFeeDisplay() {
    const methodSelect = document.getElementById('method');
    const amountInput = document.getElementById('amount');
    const feeInfo = document.getElementById('fee-info');

    if (!methodSelect || !amountInput || !feeInfo) {
      console.error('Fee display elements not found');
      return;
    }

    const isCard = methodSelect.value === 'card';
    const amount = parseFloat(amountInput.value) || 0;

    console.log('Fee display update:', { method: methodSelect.value, amount, isCard });

    if (isCard && amount > 0) {
      const totalWithFees = calculateTotalWithFees(amount);
      const processingFee = totalWithFees - amount;

      document.getElementById('base-amount').textContent = amount.toFixed(2);
      document.getElementById('processing-fee').textContent = processingFee.toFixed(2);
      document.getElementById('total-amount').textContent = totalWithFees.toFixed(2);
      feeInfo.style.display = 'block';
      console.log('Fee breakdown shown:', { base: amount, fee: processingFee, total: totalWithFees });
    } else {
      feeInfo.style.display = 'none';
      console.log('Fee breakdown hidden');
    }
  }

  // Listen for changes
  document.addEventListener('DOMContentLoaded', function() {
    console.log('Fee calculator script loaded');
    const methodSelect = document.getElementById('method');
    const amountInput = document.getElementById('amount');

    if (methodSelect && amountInput) {
      methodSelect.addEventListener('change', updateFeeDisplay);
      amountInput.addEventListener('input', updateFeeDisplay);
      console.log('Event listeners attached');

      // Initial check
      updateFeeDisplay();
    } else {
      console.error('Form elements not found');
    }
  });
</script>
{% endblock %}